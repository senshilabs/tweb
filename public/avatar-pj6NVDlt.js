import{B as q,I as U,r as $}from"./button-cd5aSUJI.js";import{g as ee,L as te,t as ne,C as K,m as ie}from"./wrapEmojiText-D1mfdW8n.js";import{aq as se,a as oe,ar as M,E as re,ap as A,d as _,af as ae,i as N,ao as F,h as ce,e as le,Y as de}from"./index-BhLliitP.js";import{a as S,d as he}from"./page-B6X-pc7k.js";import{S as ue}from"./scrollable-PCmW2Lw6.js";function pe(t){if(t.key==="Enter"&&!se&&!t.isComposing){if(oe.settings.sendShortcut==="enter")return t.shiftKey||t.ctrlKey||t.metaKey?void 0:!0;{const n=M?t.metaKey:t.ctrlKey;if(t.shiftKey||(M?t.ctrlKey:t.metaKey))return;if(n)return!0}}return!1}function we(t){t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}function Pe(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()}function fe(t,n,e){const o=e?e.add(t):t.addEventListener.bind(t);"webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange".split(" ").forEach(i=>{o(i,n,!1)})}function Y(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function ke(){return!!Y()}const me=(t,n={})=>{const e=t?.split(" ");return q("btn-icon"+(e?.length>1?" "+e.slice(1).join(" "):""),{icon:e?.[0]||void 0,...n})},x=document.body;let g=x;const z=()=>{g=Y()||x,w.reAppend()};fe(x,z);const p=class p extends re{constructor(n,e={}){if(super(!1),this.element=document.createElement("div"),this.container=document.createElement("div"),this.header=document.createElement("div"),this.title=document.createElement("div"),this.element.classList.add("popup"),this.element.className="popup"+(n?" "+n:""),this.container.classList.add("popup-container","z-depth-1"),A.isDarkOverlayActive&&(this.night=!0,this.element.classList.add("night")),this.header.classList.add("popup-header"),e.title&&(this.title.classList.add("popup-title"),typeof e.title=="string"?_(this.title,e.title):typeof e.title!="boolean"&&this.title.append(e.title),this.header.append(this.title)),this.isConfirmationNeededOnClose=e.isConfirmationNeededOnClose,this.middlewareHelper=ee(),this.listenerSetter=new te,this.managers=p.MANAGERS,this.confirmShortcutIsSendShortcut=e.confirmShortcutIsSendShortcut,e.closable&&(this.btnClose=me("",{noRipple:!0}),this.btnClose.classList.add("popup-close"),this.header.prepend(this.btnClose),e.onBackClick?(this.btnCloseAnimatedIcon=document.createElement("div"),this.btnCloseAnimatedIcon.classList.add("animated-close-icon"),this.btnClose.append(this.btnCloseAnimatedIcon)):this.btnClose.append(U("close")),S(this.btnClose,()=>{e.onBackClick&&this.btnCloseAnimatedIcon.classList.contains("state-back")?e.onBackClick()!==!1&&this.btnCloseAnimatedIcon.classList.remove("state-back"):this.hide()},{listenerSetter:this.listenerSetter})),this.withoutOverlay=e.withoutOverlay,this.withoutOverlay&&this.element.classList.add("no-overlay"),e.overlayClosable&&S(this.element,o=>{ae(o.target,"popup-container")||!o.target.isConnected||this.hide()},{listenerSetter:this.listenerSetter}),e.withConfirm&&(this.btnConfirm=document.createElement("button"),this.btnConfirm.classList.add("btn-primary","btn-color-primary"),e.withConfirm!==!0&&this.btnConfirm.append(N(e.withConfirm)),this.header.append(this.btnConfirm)),this.container.append(this.header),e.body&&(this.body=document.createElement("div"),this.body.classList.add("popup-body"),this.container.append(this.body)),e.scrollable){const o=this.scrollable=new ue(this.body);if(this.attachScrollableListeners(),e.floatingHeader){this.attachScrollableListeners(this.header);const i=document.createElement("div");i.classList.add("popup-header-background"),this.header.prepend(i),this.header.classList.add("is-floating")}this.body||this.header.after(o.container)}e.footer&&(this.footer=document.createElement("div"),this.footer.classList.add("popup-footer"),(this.body||this.container).append(this.footer)),this.btnConfirmOnEnter=this.btnConfirm,this.setButtons(e.buttons),this.element.append(this.container),p.POPUPS.push(this)}setButtons(n){if(this.buttons=n,this.buttonsEl&&(this.buttonsEl.remove(),this.buttonsEl=void 0),!n?.length)return;const e=this.buttonsEl=document.createElement("div");e.classList.add("popup-buttons");const o=n.map(i=>{const a=document.createElement("button");if(a.className="popup-button btn"+(i.isDanger?" danger":" primary"),i.noRipple||$(a),i.text?a.append(i.text):i.langKey&&a.append(N(i.langKey,i.langArgs)),i.iconLeft||i.iconRight){const f=U(i.iconLeft||i.iconRight,"popup-button-icon",i.iconLeft?"left":"right");a.classList.add("with-icon"),i.iconLeft?a.prepend(f):a.append(f)}return S(a,async f=>{let c=i.callback?.(f);if(c!==void 0&&c instanceof Promise){const m=ne([i.element],!0);try{c=await c}catch{c=!1}c===!1&&m()}c!==!1&&this.hide()},{listenerSetter:this.listenerSetter}),i.element=a});if(!this.btnConfirmOnEnter&&n.length===2){const i=n.find(a=>!a.isCancel);i&&(this.btnConfirmOnEnter=i.element)}n.length>=3&&e.classList.add("is-vertical-layout"),e.append(...o),this.container.append(e)}attachScrollableListeners(n){return this.scrollable.attachBorderListeners(n)}onContentUpdate(){this.scrollable?.onAdditionalScroll?.()}show(){this.navigationItem={type:"popup",onPop:()=>{if(this.isConfirmationNeededOnClose){const n=this.isConfirmationNeededOnClose();if(n)return Promise.resolve(n).then(()=>{this.destroy()}),!1}return this.destroy()}},F.pushItem(this.navigationItem),ce(),g.append(this.element),this.element.offsetWidth,this.element.classList.add("active"),this.onContentUpdate(),this.withoutOverlay||(A.isOverlayActive=!0,K.checkAnimations2(!0)),setTimeout(()=>{this.element.classList.contains("active")&&this.listenerSetter.add(document.body)("keydown",n=>{!this.btnConfirmOnEnter||this.btnConfirmOnEnter.disabled||p.POPUPS[p.POPUPS.length-1]!==this||(this.confirmShortcutIsSendShortcut?pe(n):n.key==="Enter")&&(he(this.btnConfirmOnEnter),le(n))})},0)}hide(){this.destroyed||!this.navigationItem||F.backByItem(this.navigationItem)}hideWithCallback(n){this.addEventListener("closeAfterTimeout",n),this.hide()}forceHide(){return this.destroy()}destroy(){this.destroyed||(this.destroyed=!0,this.dispatchEvent("close"),this.element.classList.add("hiding"),this.element.classList.remove("active"),this.listenerSetter.removeAll(),this.middlewareHelper.destroy(),this.withoutOverlay||(A.isOverlayActive=!1),F.removeItem(this.navigationItem),this.navigationItem=void 0,de(p.POPUPS,this),z(),setTimeout(()=>{this.element.remove(),this.dispatchEvent("closeAfterTimeout"),this.cleanup(),this.scrollable?.destroy(),this.withoutOverlay||K.checkAnimations2(!1)},250))}static reAppend(){this.POPUPS.forEach(n=>{const{element:e,container:o}=n,i=e.parentElement;i&&i!==g&&g!==o&&g.append(e)})}static getPopups(n){return this.POPUPS.filter(e=>e instanceof n)}static createPopup(n,...e){return new n(...e)}};p.POPUPS=[];let w=p;const Oe=t=>(t.find(e=>e.isCancel)||t.push({langKey:"Cancel",isCancel:!0}),t);function ve(t,n){let e,o,i,a=0,f=0,c=0,m=0,v=0;const I=4,h={},X=50,H=200,R=200;t.complete?B():t.onload=B;function j(){o.removeEventListener("mousedown",E),o.removeEventListener("touchstart",E),o.removeEventListener("wheel",W),document.removeEventListener("mouseup",C),document.removeEventListener("touchend",C),document.removeEventListener("mousemove",b),document.removeEventListener("touchmove",b),document.removeEventListener("keypress",T),e.remove(),o.remove(),i.remove()}function G(){o.addEventListener("mousedown",E,!1),o.addEventListener("touchstart",E,!1),o.addEventListener("wheel",W,!1),document.addEventListener("keypress",T,!1)}function B(){t.classList.add("crop-blur"),t.draggable=!1,i=new Image,i.src=t.src,i.draggable=!1,i.classList.add("crop-overlay-image"),n||(n=document.createElement("canvas")),e=document.createElement("div"),e.classList.add("crop-component"),o=document.createElement("div"),o.classList.add("crop-overlay");const s=document.createElement("div");s.classList.add("crop-overlay-color"),e.appendChild(o),t.parentNode.appendChild(e),e.appendChild(i),e.appendChild(t),e.appendChild(s),o.appendChild(i),i.style.maxWidth=t.width+"px",v=t.naturalWidth/t.offsetWidth;const d=t.offsetWidth/2-H/2,l=t.offsetHeight/2-R/2;D(H,R),P(d,l),k(d,l),G()}function D(s,r){c=s*v,m=r*v,o.style.width=s+"px",o.style.height=r+"px"}function P(s,r){f=r*v,a=s*v,i.style.top=-r+"px",i.style.left=-s+"px"}function k(s,r){o.style.top=r+"px",o.style.left=s+"px"}function Z(s){h.container_width=o.offsetWidth,h.container_height=o.offsetHeight,h.container_left=o.offsetLeft,h.container_top=o.offsetTop,h.mouse_x=(s.clientX||s.pageX||s.touches&&s.touches[0].clientX)+window.scrollX,h.mouse_y=(s.clientY||s.pageY||s.touches&&s.touches[0].clientY)+window.scrollY}function O(s){s=s*Math.PI*2;const r=Math.floor(o.clientWidth+s),d=Math.floor(o.clientHeight+s),l=i.clientWidth,L=i.clientHeight;let u,y;if(r<X)return;if(r>l)return;u=o.offsetLeft-s/2,y=o.offsetTop-s/2;const J=u+r,Q=y+d;u<0&&(u=0),y<0&&(y=0),!(J>l)&&(Q>L||(D(r,r),P(u,y),k(u,y)))}function T(s){switch(s.preventDefault(),String.fromCharCode(s.charCode)){case"+":O(I);break;case"-":O(-I);break}}function W(s){s.preventDefault(),O(s.deltaY>0?1:-1)}function E(s){s.preventDefault(),s.stopPropagation(),Z(s),document.addEventListener("mousemove",b),document.addEventListener("touchmove",b),document.addEventListener("mouseup",C),document.addEventListener("touchend",C)}function C(s){s.preventDefault(),document.removeEventListener("mouseup",C),document.removeEventListener("touchend",C),document.removeEventListener("mousemove",b),document.removeEventListener("touchmove",b)}function b(s){const r={x:0,y:0};s.preventDefault(),s.stopPropagation(),r.x=s.pageX||s.touches&&s.touches[0].pageX,r.y=s.pageY||s.touches&&s.touches[0].pageY;let d=r.x-(h.mouse_x-h.container_left),l=r.y-(h.mouse_y-h.container_top);const L=o.offsetWidth,u=o.offsetHeight;d<0?d=0:d>i.offsetWidth-L&&(d=i.offsetWidth-L),l<0?l=0:l>i.offsetHeight-u&&(l=i.offsetHeight-u),P(d,l),k(d,l)}function V(){n.width=c,n.height=m,n.getContext("2d").drawImage(t,a,f,c,m,0,0,c,m)}return{crop:V,removeHandlers:j}}function Ce(t,n){return new Promise(e=>{const o=new FileReader;o.addEventListener("loadend",i=>{e(i.target.result)}),o[n](t)})}function be(t){return Ce(t,"readAsDataURL")}class Ae extends w{constructor(n={}){super("popup-avatar",{closable:!0}),this.image=new Image,this.cropper={crop:()=>{},removeHandlers:()=>{}},this.h6=document.createElement("h6"),_(this.h6,"Popup.Avatar.Title"),this.btnClose.classList.remove("btn-icon"),this.header.append(this.h6),this.cropContainer=document.createElement("div"),this.cropContainer.classList.add("crop"),this.cropContainer.append(this.image),n.isForum&&this.cropContainer.classList.add("is-forum"),this.input=document.createElement("input"),this.input.type="file",this.input.style.display="none",this.listenerSetter.add(this.input)("change",e=>{const o=e.target.files[0];o&&be(o).then(i=>{this.image=new Image,this.cropContainer.append(this.image),this.image.src=i,this.image.onload=()=>{this.show(),this.cropper=ve(this.image,this.canvas),this.input.value=""}})},!1),this.btnConfirm=q("btn-primary btn-color-primary btn-circle btn-crop btn-icon z-depth-1",{noRipple:!0,icon:"check"}),S(this.btnConfirm,()=>{this.cropper.crop(),this.hide(),this.canvas.toBlob(e=>{this.blob=e,this.darkenCanvas(),this.resolve()},"image/jpeg",1)},{listenerSetter:this.listenerSetter}),this.container.append(this.cropContainer,this.btnConfirm,this.input),this.addEventListener("closeAfterTimeout",()=>{this.cropper.removeHandlers(),this.image&&this.image.remove()})}resolve(){this.onCrop(()=>ie.upload(this.blob))}open(n,e){this.canvas=n,this.onCrop=e,this.input.click()}darkenCanvas(){const n=this.canvas.getContext("2d");n.fillStyle="rgba(0, 0, 0, 0.3)",n.fillRect(0,0,this.canvas.width,this.canvas.height)}}export{me as B,w as P,Ae as a,Oe as b,fe as c,Pe as d,be as e,pe as f,Y as g,ke as i,we as r};
//# sourceMappingURL=avatar-pj6NVDlt.js.map
